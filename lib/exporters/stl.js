// Generated by CoffeeScript 1.3.3
(function() {
  var Put, async, fs, log, wait, _ref,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  fs = require('fs');

  log = require('util').log;

  _ref = require("../toolbox"), wait = _ref.wait, async = _ref.async;

  Put = require('put');

  module.exports = (function() {

    function exports(path, options) {
      var buff;
      this.path = path;
      this.write = __bind(this.write, this);

      this.close = __bind(this.close, this);

      this.outStream = fs.createWriteStream(this.path, {
        flags: 'w'
      });
      this.nbPoints = options.nbPoints;
      this.width = options.width;
      this.height = options.height;
      this.depth = options.depth;
      this.matrix = options.matrix;
      this.bin = true;
      buff = "solid Pot\n";
      this.outStream.write(buff);
    }

    exports.prototype.close = function(cb) {
      var buff;
      buff = "endsolid Pot\n";
      this.outStream.write(buff);
      this.outStream.destroySoon();
      return async(cb);
    };

    exports.prototype.write = function(position, material) {
      var b, buff, end, g, intensityValue, n, r, v, x, y, z, _ref1;
      if (material.id === 0) {
        return 0;
      }
      x = position[0], y = position[1], z = position[2];
      end = "    endloop\n  endfacet\n";
      n = function(x, y, z) {
        return "  facet normal " + x + " " + y + " " + z + "\n    outer loop\n";
      };
      v = function(x, y, z) {
        return "      vertex " + x + " " + y + " " + z + "\n";
      };
      intensityValue = -300;
      _ref1 = material.rgb, r = _ref1[0], g = _ref1[1], b = _ref1[2];
      buff = "";
      if ((x === 0) || this.matrix([x - 1, y, z]).id <= 0) {
        buff += ("" + (n(-1, 0, 0)) + (v(x, z + 1, y)) + (v(x, z, y + 1)) + (v(x, z + 1, y + 1))) + end;
        buff += ("" + (n(-1, 0, 0)) + (v(x, z + 1, y)) + (v(x, z, y)) + (v(x, z, y + 1))) + end;
      }
      if (x === this.width - 1 || this.matrix([x + 1, y, z]).id <= 0) {
        buff += ("" + (n(1, 0, 0)) + (v(x + 1, z + 1, y)) + (v(x + 1, z + 1, y + 1)) + (v(x + 1, z, y + 1))) + end;
        buff += ("" + (n(1, 0, 0)) + (v(x + 1, z + 1, y)) + (v(x + 1, z, y + 1)) + (v(x + 1, z, y))) + end;
      }
      if ((z === 0) || this.matrix([x, y, z - 1]).id <= 0) {
        buff += ("" + (n(0, 0, -1)) + (v(x, z, y)) + (v(x + 1, z, y + 1)) + (v(x, z, y + 1))) + end;
        buff += ("" + (n(0, 0, -1)) + (v(x, z, y)) + (v(x + 1, z, y)) + (v(x + 1, z, y + 1))) + end;
      }
      if ((z === this.depth - 1) || this.matrix([x, y, z + 1]).id <= 0) {
        buff += ("" + (n(0, 0, 1)) + (v(x, z + 1, y)) + (v(x, z + 1, y + 1)) + (v(x + 1, z + 1, y + 1))) + end;
        buff += ("" + (n(0, 0, 1)) + (v(x, z + 1, y)) + (v(x + 1, z + 1, y + 1)) + (v(x + 1, z + 1, y))) + end;
      }
      if ((y === 0) || this.matrix([x, y - 1, z]).id <= 0) {
        buff += ("" + (n(0, -1, 0)) + (v(x + 1, z, y)) + (v(x, z + 1, y)) + (v(x + 1, z + 1, y))) + end;
        buff += ("" + (n(0, -1, 0)) + (v(x + 1, z, y)) + (v(x, z, y)) + (v(x, z + 1, y))) + end;
      }
      if ((y === this.height - 1) || this.matrix([x, y + 1, z]).id <= 0) {
        buff += ("" + (n(0, 1, 0)) + (v(x + 1, z, y + 1)) + (v(x + 1, z + 1, y + 1)) + (v(x, z + 1, y + 1))) + end;
        buff += ("" + (n(0, 1, 0)) + (v(x + 1, z, y + 1)) + (v(x, z + 1, y + 1)) + (v(x, z, y + 1))) + end;
      }
      this.outStream.write(buff);
      return 1;
    };

    exports.prototype.writeBinary = function() {
      var put;
      put = Put();
      put = put.word16be(24930);
      put = put.word32le(1717920867);
      put = put.word8(103);
      return put = put.write(this.outStream);
    };

    return exports;

  })();

}).call(this);
